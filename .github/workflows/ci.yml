name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # ==========================================
  # Job 1: Build and Test on Ubuntu
  # ==========================================
  build-ubuntu:
    name: ğŸ§ Ubuntu Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential
        
    - name: â„¹ï¸ Environment Info
      run: |
        echo "===================="
        echo "Build Environment"
        echo "===================="
        echo "OS: $(lsb_release -d | cut -f2)"
        echo "CMake: $(cmake --version | head -n1)"
        echo "GCC: $(g++ --version | head -n1)"
        echo "===================="
        
    - name: ğŸ—ï¸ Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_PROJECTS=ON \
          -DBUILD_TESTS=OFF
          
    - name: ğŸ”¨ Build All Targets
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)
      
    - name: ğŸ“Š Build Summary
      run: |
        echo "===================="
        echo "Build Artifacts"
        echo "===================="
        find build/bin -type f -executable | head -20
        echo "..."
        echo "Total executables: $(find build/bin -type f -executable | wc -l)"
        echo "===================="

  # ==========================================
  # Job 2: Build on macOS
  # ==========================================
  build-macos:
    name: ğŸ macOS Build
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Install Dependencies
      run: |
        brew update
        brew install cmake
        
    - name: â„¹ï¸ Environment Info
      run: |
        echo "===================="
        echo "Build Environment"
        echo "===================="
        echo "OS: $(sw_vers -productName) $(sw_vers -productVersion)"
        echo "CMake: $(cmake --version | head -n1)"
        echo "Clang: $(clang++ --version | head -n1)"
        echo "===================="
        
    - name: ğŸ—ï¸ Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_PROJECTS=ON \
          -DBUILD_TESTS=OFF
          
    - name: ğŸ”¨ Build All Targets
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(sysctl -n hw.ncpu)
      
    - name: ğŸ“Š Build Summary
      run: |
        echo "===================="
        echo "Build Artifacts"
        echo "===================="
        find build/bin -type f -perm +111 | head -20
        echo "..."
        echo "Total executables: $(find build/bin -type f -perm +111 | wc -l)"
        echo "===================="

  # ==========================================
  # Job 3: Build on Windows
  # ==========================================
  build-windows:
    name: ğŸªŸ Windows Build
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â„¹ï¸ Environment Info
      run: |
        echo "===================="
        echo "Build Environment"
        echo "===================="
        echo "OS: Windows $(Get-CimInstance Win32_OperatingSystem).Version"
        cmake --version
        echo "===================="
      shell: pwsh
        
    - name: ğŸ—ï¸ Configure CMake
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DBUILD_EXAMPLES=ON `
          -DBUILD_PROJECTS=ON `
          -DBUILD_TESTS=OFF
      shell: pwsh
          
    - name: ğŸ”¨ Build All Targets
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel
      shell: pwsh
      
    - name: ğŸ“Š Build Summary
      run: |
        echo "===================="
        echo "Build Artifacts"
        echo "===================="
        Get-ChildItem -Path build\bin -Recurse -File | Select-Object -First 20
        $count = (Get-ChildItem -Path build\bin -Recurse -File).Count
        echo "..."
        echo "Total files: $count"
        echo "===================="
      shell: pwsh

  # ==========================================
  # Job 4: Code Quality Checks
  # ==========================================
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“ Count Source Files
      run: |
        echo "===================="
        echo "Repository Statistics"
        echo "===================="
        echo "C++ Source Files: $(find src -name '*.cpp' | wc -l)"
        echo "Header Files: $(find include -name '*.h' -o -name '*.hpp' | wc -l)"
        echo "CMake Files: $(find . -name 'CMakeLists.txt' | wc -l)"
        echo "Documentation Files: $(find docs -name '*.md' | wc -l)"
        echo "===================="
        
    - name: ğŸ” Check for Common Issues
      run: |
        echo "Checking for common issues..."
        
        # Check for tabs (should use spaces)
        if grep -r $'\t' src/ include/ examples/ 2>/dev/null | grep -v Binary; then
          echo "âš ï¸  Warning: Found tabs in source files. Consider using spaces."
        else
          echo "âœ… No tabs found"
        fi
        
        # Check for trailing whitespace
        if grep -r ' $' src/ include/ examples/ 2>/dev/null | grep -v Binary; then
          echo "âš ï¸  Warning: Found trailing whitespace"
        else
          echo "âœ… No trailing whitespace"
        fi
        
        # Check for TODO/FIXME comments
        echo "TODO/FIXME comments found:"
        grep -r "TODO\|FIXME" src/ include/ examples/ 2>/dev/null | grep -v Binary || echo "None"
        
    - name: ğŸ“ Generate Report
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All quality checks passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- C++ Files: $(find src -name '*.cpp' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Headers: $(find include -name '*.h' -o -name '*.hpp' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- CMake Files: $(find . -name 'CMakeLists.txt' | wc -l)" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job 5: Documentation Check
  # ==========================================
  docs-check:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âœ… Verify Documentation Files
      run: |
        echo "Checking required documentation..."
        
        required_files=(
          "README.md"
          "CONTRIBUTING.md"
          "LICENSE"
          "docs/ARCHITECTURE.md"
          "docs/LEARNING_PATH.md"
        )
        
        all_present=true
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ Missing: $file"
            all_present=false
          fi
        done
        
        if [ "$all_present" = true ]; then
          echo "âœ… All required documentation present"
        else
          echo "âš ï¸  Some documentation files are missing"
        fi
        
    - name: ğŸ”— Check for Broken Links
      run: |
        echo "Checking for broken internal links in README..."
        # Simple check for referenced files that don't exist
        grep -o '\[.*\]([^)]*\.md)' README.md | sed 's/.*(\(.*\))/\1/' | while read link; do
          if [ ! -f "$link" ]; then
            echo "âš ï¸  Potentially broken link: $link"
          fi
        done || echo "âœ… No broken links detected"

  # ==========================================
  # Job 6: Success Notification
  # ==========================================
  success:
    name: âœ… Build Success
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-macos, build-windows, code-quality, docs-check]
    
    steps:
    - name: ğŸ‰ Success Message
      run: |
        echo "==========================================="
        echo "ğŸ‰ All CI/CD checks passed successfully! ğŸ‰"
        echo "==========================================="
        echo ""
        echo "âœ… Ubuntu build: Success"
        echo "âœ… macOS build: Success"
        echo "âœ… Windows build: Success"
        echo "âœ… Code quality: Passed"
        echo "âœ… Documentation: Complete"
        echo ""
        echo "Ready to merge! ğŸš€"
        echo "==========================================="
